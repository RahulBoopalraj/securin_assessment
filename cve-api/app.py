from flask import Flask, jsonify, request
from pymongo import MongoClient
import datetime

# Initialize Flask app
app = Flask(__name__)

# MongoDB setup
MONGO_URI = "your_mongo_uri_here"
DB_NAME = "your_db_name_here"
COLLECTION_NAME = "your_collection_name_here"

mongo_client = MongoClient(MONGO_URI)
db = mongo_client[DB_NAME]
cve_collection = db[COLLECTION_NAME]

# Routes
@app.route('/api/cve_data', methods=['GET'])
def get_all_cve_data():
    """
    Fetch all CVE data from the database.
    """
    cve_data = list(cve_collection.find({}, {'_id': 0}))
    return jsonify(cve_data)

@app.route('/api/cve_data/<cve_id>', methods=['GET'])
def get_cve_by_id(cve_id):
    """
    Fetch a specific CVE by its ID.
    """
    query = {'cve.id': cve_id}
    cve_data = cve_collection.find_one(query, {'_id': 0})
    if cve_data:
        return jsonify(cve_data)
    else:
        return jsonify({'message': f"No CVE found with ID: {cve_id}"}), 404

@app.route('/api/cve_data/recent/<int:days>', methods=['GET'])
def get_recent_cves(days):
    """
    Fetch CVEs modified within the last 'days' days.
    """
    current_date = datetime.datetime.utcnow().date()
    past_date = current_date - datetime.timedelta(days=days)

    query = {'cve.lastModified': {'$gt': past_date.strftime('%Y-%m-%d')}}
    recent_cves = list(cve_collection.find(query, {'_id': 0}))

    return jsonify(recent_cves)

# Main entry point
if __name__ == '__main__':
    app.run(debug=True)
