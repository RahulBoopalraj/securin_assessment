from flask import Flask, jsonify, request
from pymongo import MongoClient
import datetime

app = Flask(__name__)

mongo_client = MongoClient("mongodb://localhost:27017/")
db = mongo_client["Rahul_Securin"]
cve_collection = db["CVEs"]


@app.route('/api/cve_data', methods=['GET'])
def get_all_cve_data():
    cve_data = list(cve_collection.find({}, {'_id': 0}))
    return jsonify(cve_data)

@app.route('/api/cve_data/<cve_id>', methods=['GET'])
def get_cve_by_id(cve_id):
    query = {'cve.id': cve_id} 
    cve_data = cve_collection.find_one(query, {'_id': 0})
    if cve_data:
        return jsonify(cve_data)
    else:
        return jsonify({'message': f"No CVE found with ID: {cve_id}"}), 404
    

@app.route('/api/cve_data/recent/<day>', methods=['GET'])
def get_recent_cves(day):
    days = int(request.args.get('days', day)) 
    current_date = datetime.datetime.utcnow().date()

    past_date = current_date - datetime.timedelta(days=days)
    query = {'cve.lastModified': {'$gt': past_date.strftime('%Y-%m-%d')}} 
    recent_cves = list(cve_collection.find(query, {'_id': 0}))
    print(past_date.strftime('%Y-%m-%d'))
    return jsonify(recent_cves)

if __name__ == '__main__':
    app.run()